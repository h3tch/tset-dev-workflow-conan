# This CMakeLists.txt file adheres to the tset C++ developer workflow.
# See the documentation in the Makefile for more information.
# Do not edit this file.

project(PackageTest CXX)

include(${CMAKE_BINARY_DIR}/conanbuildinfo.cmake)
conan_basic_setup()

enable_testing ()
include (GoogleTest)

## Add link libraries for linking the unit test executables.

list (APPEND REQUIRED_LINK_LIBRARIES gtest_main gtest pthread)

# Add conan libraries
list (LENGTH CONAN_LIBS HAS_CONAN_LINK_LIBRARIES)
if (${HAS_CONAN_LINK_LIBRARIES})
    list (APPEND REQUIRED_LINK_LIBRARIES ${CONAN_LIBS})
endif ()

# Add the project library if it is a library
file (GLOB CPP_FILES RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} "$ENV{PROJECT_DIR}/src/*.cpp")
list (LENGTH CPP_FILES HAS_SOURCE_FILES)
if (${HAS_SOURCE_FILES} AND NOT EXISTS "$ENV{PROJECT_DIR}/src/main.cpp")
    list (APPEND REQUIRED_LINK_LIBRARIES $ENV{PROJECT_NAME})
endif ()

## Configure all .in files in the tests folder.

function (configure_all_files_in_directory DIR)
    file (GLOB FILES_TO_CONFIGURE "$ENV{PROJECT_DIR}/${DIR}/*.in")
    foreach (file ${FILES_TO_CONFIGURE})
        get_filename_component (name ${file} NAME_WE)
        configure_file("${file}" "${DIR}/${name}.h")
    endforeach ()
    if (EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
        list(APPEND CONFIG_INCLUDE_DIRS ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
        set(CONFIG_INCLUDE_DIRS ${CONFIG_INCLUDE_DIRS} PARENT_SCOPE)
    endif ()
endfunction ()

configure_all_files_in_directory("include")
configure_all_files_in_directory("src/include")
configure_all_files_in_directory("tests")
configure_all_files_in_directory("tests/include")

## Use precompiled header file

file (GLOB PCH_FILES "$ENV{PROJECT_DIR}/tests/**/test-pch.h")
list (LENGTH PCH_FILES HAS_PCH_FILES)

## Add GTest files

string (REPLACE "," ";" COMPILE_OPTIONS "$ENV{COMPILE_OPTIONS}")
file (GLOB TEST_FILES "$ENV{PROJECT_DIR}/tests/test*.cpp")
foreach (file ${TEST_FILES})
    get_filename_component (name ${file} NAME_WE)
    add_executable (${name} ${file})
    add_dependencies (${name} $ENV{PROJECT_NAME})
    set_property(TARGET ${name} PROPERTY CXX_STANDARD 17)
    target_include_directories (${name}
        PRIVATE
            $ENV{PROJECT_DIR}/include
            $ENV{PROJECT_DIR}/src/include
            $ENV{PROJECT_DIR}/tests/include
            ${CONFIG_INCLUDE_DIRS}
            ${CONAN_INCLUDE_DIRS})
    if (${HAS_PCH_FILES})
        if (DEFINED first_target)
            target_precompile_headers (${name} REUSE_FROM ${first_target})
        else ()
            message(STATUS "Use precompile header for tests.")
            target_precompile_headers (${name} PRIVATE ${PCH_FILES})
            set (first_target ${name})
        endif ()
    endif ()
    target_link_libraries (${name} ${REQUIRED_LINK_LIBRARIES})
    target_compile_options (${name} PRIVATE ${COMPILE_OPTIONS})
    gtest_discover_tests (${name})
endforeach ()
