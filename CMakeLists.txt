# This CMakeLists.txt file adheres to the tset C++ developer workflow.
# See the documentation in the Makefile for more information.
# Do not edit this file.

cmake_minimum_required (VERSION 3.16)
project ($ENV{PROJECT_NAME} VERSION $ENV{PROJECT_VERSION} LANGUAGES CXX)

# SETUP CONAN PACKAGE MANAGEMENT IN CMAKE

include(${CMAKE_BINARY_DIR}/conanbuildinfo.cmake)
conan_basic_setup()

message(STATUS "CONAN_INCLUDE_DIRS: ${CONAN_INCLUDE_DIRS}")
message(STATUS "CONAN_LIB_DIRS: ${CONAN_LIB_DIRS}")
message(STATUS "CONAN_LIBS: ${CONAN_LIBS}")

## Configure all .in files in the tests folder.

function (configure_all_files_in_directory DIR)
    file (GLOB FILES_TO_CONFIGURE "$ENV{PROJECT_DIR}/${DIR}/*.in")
    foreach (file ${FILES_TO_CONFIGURE})
        get_filename_component (name ${file} NAME_WE)
        configure_file("${file}" "${DIR}/${name}.h")
    endforeach ()
    if (EXISTS ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
        list(APPEND CONFIG_INCLUDE_DIRS ${CMAKE_CURRENT_BINARY_DIR}/${DIR})
        set(CONFIG_INCLUDE_DIRS ${CONFIG_INCLUDE_DIRS} PARENT_SCOPE)
    endif ()
endfunction ()

configure_all_files_in_directory("include")
configure_all_files_in_directory("src/include")
configure_all_files_in_directory("src")

message(STATUS "CONFIG_INCLUDE_DIRS: ${CONFIG_INCLUDE_DIRS}")

# CREATE A SHARED OBJECT OR HEADER ONLY LIBRARY

file (GLOB CPP_FILES RELATIVE ${CMAKE_CURRENT_SOURCE_DIR} src/*.cpp)
list (LENGTH CPP_FILES HAS_SOURCE_FILES)

if (${HAS_SOURCE_FILES})
    if (EXISTS "$ENV{PROJECT_DIR}/src/main.cpp")
        message (STATUS "Create an executable")
        add_executable ($ENV{PROJECT_NAME} ${CPP_FILES})
    else ()
        message (STATUS "Create a shared library")
        add_library ($ENV{PROJECT_NAME} SHARED ${CPP_FILES})
    endif ()
    target_include_directories ($ENV{PROJECT_NAME}
        PUBLIC  include
        PRIVATE src/include ${CONFIG_INCLUDE_DIRS} ${CONAN_INCLUDE_DIRS})
    target_link_directories ($ENV{PROJECT_NAME} PRIVATE ${CONAN_LIB_DIRS})
    target_link_libraries ($ENV{PROJECT_NAME} ${CONAN_LIBS})
    if (EXISTS "$ENV{PROJECT_DIR}/src/include/pch.h")
        message(STATUS "Use precompile header.")
        target_precompile_headers ($ENV{PROJECT_NAME}
            PRIVATE "$ENV{PROJECT_DIR}/src/include/pch.h")
    endif ()
    set_property(TARGET $ENV{PROJECT_NAME} PROPERTY CXX_STANDARD 17)
else ()
    message (STATUS "Create a header only library")
    add_library ($ENV{PROJECT_NAME} INTERFACE)
    target_include_directories ($ENV{PROJECT_NAME}
        INTERFACE include ${CMAKE_CURRENT_BINARY_DIR} ${CONAN_INCLUDE_DIRS})
endif ()

# ADD UNIT TESTS

include (tests/CMakeLists.txt) 
